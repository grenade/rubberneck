sources:
  journald:
    type: journald
    include_units:
      - resonance-miner.service
      - resonance-node.service
      - sshd.service
      - substrate-telemetry-shard.service
transforms:
  add_meta:
    type: remap
    inputs:
      - journald
    source: |
      .version = "1.1"

      # GELF timestamp (seconds, float); fall back to now() if missing
      .timestamp = to_unix_timestamp!(.timestamp ?? now())

      .host = get_hostname!()

      # Service name (as an additional GELF field must start with "_")
      ._service = to_string(._SYSTEMD_UNIT) ?? "unknown"

      # Syslog level 0..7 if present
      if exists(.PRIORITY) { 
        .level = to_int(.PRIORITY) ?? .PRIORITY 
      }

      # Message fields (safe conversion + defaults)
      .short_message = to_string(.MESSAGE) ?? "<no message>"
      .full_message  = to_string(.MESSAGE) ?? ""

      # Optional tidy-up (safe even if absent)
      del(.SYSLOG_FACILITY)
      del(._SOURCE_MONOTONIC_TIMESTAMP)
sinks:
  graylog:
    type: socket
    inputs:
      - add_meta
    address: "logs.res.fm:12201"
    mode: tcp
    framing:
      method: character_delimited
      character_delimited:
        delimiter: "\0"
    encoding:
      codec: json
    buffer:
      type: disk
      max_size: 536870912
      when_full: block
