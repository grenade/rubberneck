---
hostname: zaphod
domain: thgttg.com
action: sync
ssh:
  address: 95.216.75.94
  port: 22
os:
  name: centos
repository:
  -
    name: vector
    list: |
      [vector]
      name = Vector
      baseurl = https://yum.vector.dev/stable/vector-0/$basearch/
      enabled=1
      gpgcheck=1
      repo_gpgcheck=1
      priority=1
      gpgkey=https://keys.datadoghq.com/DATADOG_RPM_KEY_CURRENT.public
             https://keys.datadoghq.com/DATADOG_RPM_KEY_B01082D3.public
             https://keys.datadoghq.com/DATADOG_RPM_KEY_FD4BF915.public
    trust:
      - https://keys.datadoghq.com/DATADOG_RPM_KEY_CURRENT.public
      - https://keys.datadoghq.com/DATADOG_RPM_KEY_B01082D3.public
      - https://keys.datadoghq.com/DATADOG_RPM_KEY_FD4BF915.public
package:
  - curl
  - dnf-automatic
  - git
  - jq
  - lshw
  - ncurses-base
  - ncurses-compat-libs
  - oqsprovider
  - podman
  - python3-pip
  - vector
user:
  -
    username: resonance
    system: true
    authorized:
      keys:
        # rubberneck (resonance@kavula)
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGxhedWcnCqs5Kdw/aMgYH0ofFhKK9cH4bR3vlRQm6Rd
firewall:
  port:
    - 9100/tcp # prometheus node exporter
    - 9000/tcp # graylog
    - 12201/tcp # graylog ingest
    - 12201/udp # graylog ingest
command:
  - sudo passwd -l root
  - timedatectl show | grep Timezone=UTC &> /dev/null || sudo timedatectl set-timezone UTC
  - systemctl is-active prometheus-node-exporter.service || sudo systemctl restart prometheus-node-exporter.service
  - test -x /usr/local/bin/yq || sudo pip install yq
archive:
  -
    source: https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz
    target: /tmp/node_exporter-1.8.2.linux-amd64.tar.gz
    sha256: 6809dd0b3ec45fd6e992c19071d6b5253aed3ead7bf0686885a51d85c6643c66
    extract:
      -
        source: node_exporter-1.8.2.linux-amd64/node_exporter
        target: /usr/local/bin/node_exporter
        sha256: 0c9219b9860c6250c0bc3da5d79bd79c17f3938345fa7503f95cfa2ad7c3ba1d
        command:
          pre:
            - systemctl is-active --quiet prometheus-node-exporter.service && sudo systemctl stop prometheus-node-exporter.service
          post:
            - sudo systemctl daemon-reload
            - sudo systemctl start prometheus-node-exporter.service
file:
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/static/etc/ssh/sshd_config.d/39-ed25519-only.conf
    target: /etc/ssh/sshd_config.d/39-ed25519-only.conf
    command:
      post:
        - sudo systemctl restart sshd.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/static/etc/systemd/system/prometheus-node-exporter.service
    target: /etc/systemd/system/prometheus-node-exporter.service
    command:
      pre:
        - systemctl is-active --quiet prometheus-node-exporter.service && sudo systemctl stop prometheus-node-exporter.service
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled prometheus-node-exporter.service || sudo systemctl enable prometheus-node-exporter.service
        - systemctl is-active prometheus-node-exporter.service || sudo systemctl start prometheus-node-exporter.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/zaphod/etc/cockpit/cockpit.conf
    target: /etc/cockpit/cockpit.conf
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/static/etc/pki/tls/openssl.d/oqs-provider.conf
    target: /etc/pki/tls/openssl.d/oqs-provider.conf
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/zaphod/etc/containers/systemd/graylog.network
    target: /etc/containers/systemd/graylog.network
    command:
      pre:
        - test -d /etc/containers/systemd || sudo mkdir -p /etc/containers/systemd
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled log-aggregator.pod || sudo systemctl enable log-aggregator.pod
        - systemctl is-active mongo.service && sudo systemctl restart mongo.service
        - systemctl is-active opensearch.service && sudo systemctl restart opensearch.service
        - systemctl is-active graylog.service && sudo systemctl restart graylog.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/zaphod/etc/graylog/graylog.env.gpg
    target: /etc/graylog/graylog.env
    sha256: f340030df1707079633175f78047d4d843e458dc0b792c0f1e5cb776a5bd9853
    chmod: 600
    command:
      pre:
        - test -d /etc/graylog || sudo install -d -m 0755 /etc/graylog
      post:
        - systemctl is-active graylog.service && sudo systemctl restart graylog.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/zaphod/etc/opensearch/opensearch.env.gpg
    target: /etc/opensearch/opensearch.env
    sha256: f7cff6c6b8112f6e88e70e809726b78961c006b01976c70824dd7da66af45aa9
    chmod: 600
    command:
      pre:
        - test -d /etc/opensearch || sudo install -d -m 0755 /etc/opensearch
      post:
        - systemctl is-active opensearch.service && sudo systemctl restart opensearch.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/zaphod/etc/oauth2-proxy/oauth2-proxy.env.gpg
    target: /etc/oauth2-proxy/oauth2-proxy.env
    sha256: e8b3aa69636ee2e980f9b4e68011dda6efb17018357ce517041364a315755614
    chmod: 600
    command:
      pre:
        - test -d /etc/oauth2-proxy || sudo install -d -m 0755 /etc/oauth2-proxy
      post:
        - systemctl is-active oauth2-proxy.service && sudo systemctl restart oauth2-proxy.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/zaphod/etc/sysctl.d/99-opensearch.conf
    target: /etc/sysctl.d/99-opensearch.conf
    command:
      post:
        - sudo sysctl --system
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/zaphod/etc/containers/systemd/mongo.volume
    target: /etc/containers/systemd/mongo.volume
    command:
      pre:
        - test -d /etc/containers/systemd || sudo mkdir -p /etc/containers/systemd
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/zaphod/etc/containers/systemd/mongo.container
    target: /etc/containers/systemd/mongo.container
    command:
      pre:
        - test -d /etc/containers/systemd || sudo mkdir -p /etc/containers/systemd
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled mongo.service || sudo systemctl enable mongo.service
        - systemctl is-active mongo.service || sudo systemctl start mongo.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/zaphod/etc/containers/systemd/opensearch.volume
    target: /etc/containers/systemd/opensearch.volume
    command:
      pre:
        - test -d /etc/containers/systemd || sudo mkdir -p /etc/containers/systemd
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/zaphod/etc/containers/systemd/opensearch.container
    target: /etc/containers/systemd/opensearch.container
    command:
      pre:
        - test -d /etc/containers/systemd || sudo mkdir -p /etc/containers/systemd
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled opensearch.service || sudo systemctl enable opensearch.service
        - systemctl is-active opensearch.service || sudo systemctl start opensearch.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/zaphod/etc/containers/systemd/graylog.container
    target: /etc/containers/systemd/graylog.container
    command:
      pre:
        - test -d /etc/containers/systemd || sudo mkdir -p /etc/containers/systemd
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled graylog.service || sudo systemctl enable graylog.service
        - systemctl is-active graylog.service || sudo systemctl start graylog.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/zaphod/etc/containers/systemd/oauth2-proxy.container
    target: /etc/containers/systemd/oauth2-proxy.container
    command:
      pre:
        - test -d /etc/containers/systemd || sudo mkdir -p /etc/containers/systemd
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled oauth2-proxy.service || sudo systemctl enable oauth2-proxy.service
        - systemctl is-active oauth2-proxy.service || sudo systemctl start oauth2-proxy.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/zaphod/etc/nginx/sites-available/logs.res.fm.conf
    target: /etc/nginx/sites-available/logs.res.fm.conf
    command:
      pre:
        - >
          sudo certbot certonly
          -m ops@res.fm
          --agree-tos
          --no-eff-email
          --noninteractive
          --cert-name logs.res.fm
          --expand
          --allow-subset-of-names
          --key-type ecdsa
          --preferred-challenges http
          --webroot
          --webroot-path /var/www/html
          -d logs.res.fm
      post:
        - sudo systemctl reload nginx.service
