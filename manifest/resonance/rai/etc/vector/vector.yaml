sources:
  journald:
    type: journald
    include_units:
      - resonance-miner.service
      - resonance-node.service
      - sshd.service
      - substrate-telemetry-shard.service

transforms:
  to_gelf:
    type: remap
    inputs:
      - journald
    source: |
      ._orig = .
      ts = to_unix_timestamp(.timestamp) ?? to_unix_timestamp(now())
      lvl = 6
      if exists(.PRIORITY) { lvl = to_int(.PRIORITY) ?? 6 }
      if lvl < 0 { lvl = 0 }
      if lvl > 7 { lvl = 7 }
      sm = to_string(.message)
      if is_null(sm) { sm = to_string(.MESSAGE) }
      if is_null(sm) { sm = to_string(.SYSLOG_MESSAGE) }
      if is_null(sm) { sm = to_string(._orig.SYSLOG_IDENTIFIER) }
      if is_null(sm) { sm = "<log>" }
      fm = to_string(.message)
      if is_null(fm) { fm = to_string(.MESSAGE) }
      if is_null(fm) { fm = "" }
      svc = to_string(._SYSTEMD_UNIT)
      if is_null(svc) { svc = to_string(.SYSLOG_IDENTIFIER) }
      if is_null(svc) { svc = "unknown" }
      . = {}
      .version = "1.1"
      .timestamp = to_float(ts)
      .host = get_hostname!()
      .short_message = sm
      .full_message = fm
      .level = lvl
      ._service = svc
      ._unit = svc
      del(._orig)

  includes_message:
    type: filter
    inputs:
      - to_gelf
    condition: '.short_message != "<no message>"'

sinks:
  graylog:
    type: socket
    inputs:
      - includes_message
    address: "logs.res.fm:12201"
    mode: tcp
    framing:
      method: character_delimited
      character_delimited:
        delimiter: "\0"
    encoding:
      codec: json
    buffer:
      type: disk
      max_size: 536870912   # bytes
      when_full: block
