---
hostname: a2
domain: quantu.se
action: sync
ssh:
  address: 117.55.193.58
  port: 22
os:
  name: ubuntu
package:
  - curl
  - git
  - python3-pip
user:
  -
    username: resonance
    system: true
    authorized:
      keys:
        # rubberneck (used by resonance@kavula)
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGxhedWcnCqs5Kdw/aMgYH0ofFhKK9cH4bR3vlRQm6Rd

        # infra (used by gitlab-runner@trillian)
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPtD6fJHw5s3xmlJS2NUEkI31tQ0Fm9SGtFVp+KpOh4u

        # engineering
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJnmT8wFTfEMxa+yTlAOZcCrq/5bJzUZc6os8fisMUfW
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGFqCub+5eqxv99NfoPo0rbMIGOvETjJndVC4QPGEP9E
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEQFXWITZHUHb/N4OElaN2+DnoVLHlHDct98u8Pp97DT
command:
  - sudo passwd -l root
  - timedatectl show | grep Timezone=UTC &> /dev/null || sudo timedatectl set-timezone UTC
  - systemctl is-active prometheus-node-exporter.service || sudo systemctl restart prometheus-node-exporter.service
  - systemctl is-active schroedinger-miner.service || sudo systemctl restart schroedinger-miner.service
  - systemctl is-active schroedinger-node.service || sudo systemctl restart schroedinger-node.service
  - systemctl is-active substrate-telemetry-shard.service || sudo systemctl restart substrate-telemetry-shard.service
archive:
  -
    source: https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz
    target: /tmp/node_exporter-1.8.2.linux-amd64.tar.gz
    sha256: 6809dd0b3ec45fd6e992c19071d6b5253aed3ead7bf0686885a51d85c6643c66
    extract:
      -
        source: node_exporter-1.8.2.linux-amd64/node_exporter
        target: /usr/local/bin/node_exporter
        sha256: 0c9219b9860c6250c0bc3da5d79bd79c17f3938345fa7503f95cfa2ad7c3ba1d
        command:
          pre:
            - systemctl is-active --quiet prometheus-node-exporter.service && sudo systemctl stop prometheus-node-exporter.service
          post:
            - sudo systemctl daemon-reload
            - sudo systemctl start prometheus-node-exporter.service
  -
    source: https://github.com/Quantus-Network/chain/releases/download/v0.2.8/quantus-node-v0.2.8-x86_64-unknown-linux-gnu.tar.gz
    target: /tmp/quantus-node-v0.2.8-x86_64-unknown-linux-gnu.tar.gz
    sha256: aaa78fd7bfdcbd56c00db3f1310eaf120719587e5d2035dbb9c14aaaede0dbec
    extract:
      -
        source: quantus-node
        target: /usr/local/bin/quantus-node
        sha256: b0b27349fa5ce9ae29ddbba14b06564a774477c0e1c6f611933991e5cec5d10d
        command:
          pre:
            - systemctl is-active --quiet schroedinger-node.service && sudo systemctl stop schroedinger-node.service
          post:
            - sudo systemctl start schroedinger-node.service
file:
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/static/etc/ssh/sshd_config.d/39-ed25519-only.conf
    target: /etc/ssh/sshd_config.d/39-ed25519-only.conf
    command:
      post:
        - sudo systemctl restart sshd.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/static/etc/systemd/system/prometheus-node-exporter.service
    target: /etc/systemd/system/prometheus-node-exporter.service
    command:
      pre:
        - systemctl is-active --quiet prometheus-node-exporter.service && sudo systemctl stop prometheus-node-exporter.service
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled prometheus-node-exporter.service || sudo systemctl enable prometheus-node-exporter.service
        - systemctl is-active prometheus-node-exporter.service || sudo systemctl start prometheus-node-exporter.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/static/etc/pki/tls/openssl.d/oqs-provider.conf
    target: /etc/pki/tls/openssl.d/oqs-provider.conf
  -
    source: https://cdn.res.fm/quantus-miner/0.3.0/quantus-miner
    target: /usr/local/bin/quantus-miner
    sha256: e24e6dc5f59113a916f4a23e30aea05b2b78addeb1658acc1e4595fa4438092c
    chmod: '+x'
    command:
      pre:
        - systemctl is-active --quiet schroedinger-miner.service && sudo systemctl stop schroedinger-miner.service
      post:
        - sudo systemctl start schroedinger-miner.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/a2.quantu.se/etc/systemd/system/schroedinger-miner.service
    target: /etc/systemd/system/schroedinger-miner.service
    command:
      pre:
        - id schroedinger || sudo useradd --system --create-home --home-dir /var/lib/schroedinger --user-group schroedinger
        - systemctl is-active --quiet schroedinger-miner.service && sudo systemctl stop schroedinger-miner.service
        - systemctl is-active --quiet schroedinger-miner.service && sudo systemctl stop schroedinger-miner.service
      post:
        - sudo systemctl daemon-reload
        - sudo systemctl start schroedinger-miner.service
        - systemctl is-enabled schroedinger-miner.service || sudo systemctl enable schroedinger-miner.service
        - systemctl is-active --quiet schroedinger-node.service || sudo systemctl start schroedinger-node.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/resonance/a2.quantu.se/etc/systemd/system/schroedinger-node.service
    target: /etc/systemd/system/schroedinger-node.service
    command:
      pre:
        - id schroedinger || sudo useradd --system --create-home --home-dir /var/lib/schroedinger --user-group schroedinger
        - systemctl is-active --quiet schroedinger-node.service && sudo systemctl stop schroedinger-node.service
      post:
        - sudo systemctl daemon-reload
        - sudo systemctl start schroedinger-node.service
        - systemctl is-enabled schroedinger-node.service || sudo systemctl enable schroedinger-node.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/static/etc/systemd/system/substrate-telemetry-shard.service
    target: /etc/systemd/system/substrate-telemetry-shard.service
    command:
      pre:
        - systemctl is-active --quiet substrate-telemetry-shard.service && sudo systemctl stop substrate-telemetry-shard.service
      post:
        - sudo systemctl daemon-reload
        - sudo systemctl start substrate-telemetry-shard.service
        - systemctl is-enabled substrate-telemetry-shard.service || sudo systemctl enable substrate-telemetry-shard.service
