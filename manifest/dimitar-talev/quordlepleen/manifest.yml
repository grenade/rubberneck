---
hostname: quordlepleen
domain: thgttg.com
action: sync
ssh:
  port: 52212
os:
  name: fedora
package:
  - cockpit-pcp
  - curl
  - dnf-automatic
  - git
  - pip
user:
  -
    username: grenade
    authorized:
      keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPRO2rPB5URKyMSGeMwFd9Npzl/XywJWO9F2N/xylCVm
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPb24HEQ++aNFWaqVyMtIs6GotUB8R+q61XOoI2z6uMj
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAID83JhRg/lgInWM/XwMfjaDzTMDPS5M7zuVeOm0O5Y5W
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGILqCEkUGPF3c+riHfLtkpsSP3nw/HjQUvTs66JsZ6a
firewall:
  port:
    - 8336/udp
    - 8337/tcp
    - 8338/tcp
    - 9100/tcp
command:
  - sudo passwd -l root
  - timedatectl show | grep Timezone=UTC &> /dev/null || sudo timedatectl set-timezone UTC
  - test -x /usr/local/bin/node_exporter || ( curl -sLo /tmp/node_exporter-1.8.0.linux-amd64.tar.gz https://github.com/prometheus/node_exporter/releases/download/v1.8.0/node_exporter-1.8.0.linux-amd64.tar.gz && sudo tar xvfz /tmp/node_exporter-1.8.0.linux-amd64.tar.gz -C /usr/local/bin --strip-components=1 node_exporter-1.8.0.linux-amd64/node_exporter )
  - systemctl is-active prometheus-node-exporter.service || sudo systemctl restart prometheus-node-exporter.service
  - for core in {25..204}; do systemctl list-units --type=service | grep quilibrium-worker@${core}.service && sudo systemctl stop quilibrium-worker@${core}.service; done
  - for core in {1..24}; do systemctl is-active quilibrium-worker@${core}.service || sudo systemctl restart quilibrium-worker@${core}.service; done
  - systemctl is-active quilibrium.service || sudo systemctl restart quilibrium.service
file:
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/static/etc/systemd/system/prometheus-node-exporter.service
    target: /etc/systemd/system/prometheus-node-exporter.service
    command:
      pre:
        - systemctl is-active --quiet prometheus-node-exporter.service && sudo systemctl stop prometheus-node-exporter.service
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled prometheus-node-exporter.service || sudo systemctl enable prometheus-node-exporter.service
        - systemctl is-active prometheus-node-exporter.service || sudo systemctl start prometheus-node-exporter.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/dimitar-talev/quordlepleen/etc/cockpit/cockpit.conf
    target: /etc/cockpit/cockpit.conf
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/static/etc/systemd/system/quilibrium.service
    target: /etc/systemd/system/quilibrium.service
    command:
      pre:
        - sudo systemctl stop 'quilibrium-worker@*'.service
        - systemctl is-active --quiet quilibrium.service && sudo systemctl stop quilibrium.service
        - id quilibrium || sudo useradd --system --create-home --home-dir /var/lib/quilibrium --user-group quilibrium
        - sudo -u quilibrium mkdir -p /var/lib/quilibrium/.node
      post:
        - sudo systemctl daemon-reload
        - for core in {1..24}; do sudo systemctl start quilibrium-worker@${core}.service; done
        - systemctl is-enabled quilibrium.service || sudo systemctl enable quilibrium.service
        - sudo systemctl start quilibrium.service
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/static/etc/systemd/system/quilibrium-worker%40.service
    target: /etc/systemd/system/quilibrium-worker@.service
    command:
      pre:
        - sudo systemctl stop 'quilibrium-worker@*'.service
        - id quilibrium || sudo useradd --system --create-home --home-dir /var/lib/quilibrium --user-group quilibrium
        - sudo -u quilibrium mkdir -p /var/lib/quilibrium/.node
      post:
        - sudo systemctl daemon-reload
        - for core in {1..24}; do sudo systemctl start quilibrium-worker@${core}.service; done
  -
    source: https://releases.quilibrium.com/node-1.4.19.1-linux-amd64
    target: /var/lib/quilibrium/.local/bin/quilibrium
    sha256: 81350ce119fd06a1d3007e1af3925603207090e603a1050cfc0bda0c61fde15e
    chown: quilibrium:quilibrium
    chmod: '+x'
    command:
      pre:
        - sudo systemctl stop 'quilibrium-worker@*'.service
        - systemctl is-active --quiet quilibrium.service && sudo systemctl stop quilibrium.service
        - id quilibrium || sudo useradd --system --create-home --home-dir /var/lib/quilibrium --user-group quilibrium
        - sudo -u quilibrium mkdir -p /var/lib/quilibrium/.local/bin
      post:
        - sudo chown quilibrium:quilibrium /var/lib/quilibrium/.local/bin/quilibrium
        - sudo semanage fcontext -a -t bin_t /var/lib/quilibrium/.local/bin/quilibrium
        - sudo chcon -Rv -u system_u -t bin_t /var/lib/quilibrium/.local/bin/quilibrium
        #- sudo restorecon -R -v /var/lib/quilibrium/.local/bin/quilibrium
        - sudo systemctl daemon-reload
        - for core in {1..24}; do sudo systemctl start quilibrium-worker@${core}.service; done
        - systemctl is-enabled quilibrium.service || sudo systemctl enable quilibrium.service
          sudo systemctl start quilibrium.service
  -
    source: https://releases.quilibrium.com/node-1.4.19.1-linux-amd64.dgst
    target: /var/lib/quilibrium/.local/bin/quilibrium.dgst
    sha256: 18a97a7bfa96e72b9cc342d7dff8758d6f9c30bbfe0e8adbb99491449ff3aa1d
    chown: quilibrium:quilibrium
  -
    source: https://releases.quilibrium.com/node-1.4.19.1-linux-amd64.dgst.sig.1
    target: /var/lib/quilibrium/.local/bin/quilibrium.dgst.sig.1
    sha256: 13cbb80b8bbd35c0b95717decbb6da48fd5920d8d0ba8c31af077829763962fb
    chown: quilibrium:quilibrium
  -
    source: https://releases.quilibrium.com/node-1.4.19.1-linux-amd64.dgst.sig.2
    target: /var/lib/quilibrium/.local/bin/quilibrium.dgst.sig.2
    sha256: 16f508e4f1c7d3d38a17690e83cb62af97d50759d9ef31e33cfc05f160822159
    chown: quilibrium:quilibrium
  -
    source: https://releases.quilibrium.com/node-1.4.19.1-linux-amd64.dgst.sig.3
    target: /var/lib/quilibrium/.local/bin/quilibrium.dgst.sig.3
    sha256: c05b41f264a23a9c48288fabbbdfc3efbf0a3974505699f4547548cdeebdfcb1
    chown: quilibrium:quilibrium
  -
    source: https://releases.quilibrium.com/node-1.4.19.1-linux-amd64.dgst.sig.4
    target: /var/lib/quilibrium/.local/bin/quilibrium.dgst.sig.4
    sha256: daadcb4e8e0e78c305e83942a5028321cd9939875a5982bc5f15e6f0dfb7eaa3
    chown: quilibrium:quilibrium
  -
    source: https://releases.quilibrium.com/node-1.4.19.1-linux-amd64.dgst.sig.5
    target: /var/lib/quilibrium/.local/bin/quilibrium.dgst.sig.5
    sha256: 316eac80a3390ddd3ed436039b59898690eee0b5f3b4148b9ae4ce9369dcda91
    chown: quilibrium:quilibrium
  -
    source: https://releases.quilibrium.com/node-1.4.19.1-linux-amd64.dgst.sig.6
    target: /var/lib/quilibrium/.local/bin/quilibrium.dgst.sig.6
    sha256: 060bbc916d4e889419604023927afec45e61c5bc06bf11596d8e8b7662afb651
    chown: quilibrium:quilibrium
  -
    source: https://releases.quilibrium.com/node-1.4.19.1-linux-amd64.dgst.sig.8
    target: /var/lib/quilibrium/.local/bin/quilibrium.dgst.sig.8
    sha256: 1ada0d4ffdb63237d58e83e6e7e42a11f573b3759981365b7b7c4ef86a783db8
    chown: quilibrium:quilibrium
  -
    source: https://releases.quilibrium.com/node-1.4.19.1-linux-amd64.dgst.sig.9
    target: /var/lib/quilibrium/.local/bin/quilibrium.dgst.sig.9
    sha256: 8744d27a0712f8880802a1f12147fa1c812143352e2d2b1aa3d5beb99e62126e
    chown: quilibrium:quilibrium
  -
    source: https://releases.quilibrium.com/node-1.4.19.1-linux-amd64.dgst.sig.13
    target: /var/lib/quilibrium/.local/bin/quilibrium.dgst.sig.13
    sha256: 317950a95953e0d8551e59ee857ae073a6bb1933d9b4c8824fb7cbf92a042f76
    chown: quilibrium:quilibrium
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/static/etc/sysctl.d/90-quilibrium.conf
    target: /etc/sysctl.d/90-quilibrium.conf
    command:
      post:
        - sudo sysctl -w net.core.rmem_max=4194304
        - sudo sysctl -w net.core.wmem_max=4194304
  -
    source: https://raw.githubusercontent.com/grenade/rubberneck/main/manifest/dimitar-talev/quordlepleen/var/lib/quilibrium/.node/config.yml.gpg
    target: /var/lib/quilibrium/.node/config.yml
    sha256: f78c4ec26923b85871dfd3a0f94c72c8053aec7fda3551822b90ddf1400f22dd
    command:
      pre:
        - sudo systemctl stop 'quilibrium-worker@*'.service
      post:
        - for core in {1..24}; do sudo systemctl start quilibrium-worker@${core}.service; done
